<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recuperar Senha - PARDARIA</title>
<link rel="stylesheet" href="login.css">
<style>
.step {
    display: none;
}
.step.active {
    display: block;
}
.code-inputs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
}
.code-inputs input {
    width: 50px !important;
    height: 50px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
}
.resend-code {
    text-align: center;
    margin-top: 15px;
    font-size: 0.9em;
}
.resend-code button {
    background: none;
    border: none;
    color: var(--cor-link-acao);
    text-decoration: underline;
    cursor: pointer;
    font-weight: 600;
}
.resend-code button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.back-link {
    text-align: center;
    margin-top: 20px;
}
.back-link a {
    color: var(--cor-link-acao);
    text-decoration: none;
    font-weight: 600;
}
.back-link a:hover {
    text-decoration: underline;
}
</style>
</head>
<body>
<div class="container">
<div class="login-card">
<div class="logo">
<h1>üçû PARDARIA</h1>
<p>Padaria Artesanal</p>
</div>
<div class="form-content-area">
<!-- Passo 1: Solicitar Email -->
<div id="step1" class="step active">
<h2>Recuperar Senha</h2>
<p style="text-align: center; color: #666; margin-bottom: 20px;">
Digite seu email para receber o c√≥digo de verifica√ß√£o
</p>
<form id="emailForm">
<div class="form-group">
<label for="email">Email:</label>
<input type="email" id="email" name="email" required>
</div>
<button type="submit" class="btn-login">Enviar C√≥digo</button>
<div id="mensagemEmail" class="mensagem"></div>
</form>
<p class="back-link">
<a href="login.html">‚Üê Voltar para o Login</a>
</p>
</div>

<!-- Passo 2: Verificar C√≥digo -->
<div id="step2" class="step">
<h2>Verificar C√≥digo</h2>
<p style="text-align: center; color: #666; margin-bottom: 10px;">
Digite o c√≥digo de 6 d√≠gitos enviado para
</p>
<p style="text-align: center; color: var(--cor-primaria-padaria); font-weight: 600; margin-bottom: 20px;" id="emailDisplay"></p>
<form id="codeForm">
<div class="code-inputs">
<input type="text" maxlength="1" class="code-digit" data-index="0" required>
<input type="text" maxlength="1" class="code-digit" data-index="1" required>
<input type="text" maxlength="1" class="code-digit" data-index="2" required>
<input type="text" maxlength="1" class="code-digit" data-index="3" required>
<input type="text" maxlength="1" class="code-digit" data-index="4" required>
<input type="text" maxlength="1" class="code-digit" data-index="5" required>
</div>
<button type="submit" class="btn-login">Verificar C√≥digo</button>
<div id="mensagemCodigo" class="mensagem"></div>
</form>
<div class="resend-code">
<p>N√£o recebeu o c√≥digo?</p>
<button id="resendBtn" disabled>Reenviar c√≥digo (<span id="timer">60</span>s)</button>
</div>
<p class="back-link">
<a href="#" id="backToEmail">‚Üê Voltar</a>
</p>
</div>

<!-- Passo 3: Nova Senha -->
<div id="step3" class="step">
<h2>Nova Senha</h2>
<p style="text-align: center; color: #666; margin-bottom: 20px;">
Digite sua nova senha
</p>
<form id="passwordForm">
<div class="form-group">
<label for="novaSenha">Nova Senha:</label>
<input type="password" id="novaSenha" name="novaSenha" maxlength="20" minlength="6" required>
<small>M√≠nimo 6 caracteres, m√°ximo 20</small>
</div>
<div class="form-group">
<label for="confirmarSenha">Confirmar Senha:</label>
<input type="password" id="confirmarSenha" name="confirmarSenha" maxlength="20" minlength="6" required>
</div>
<button type="submit" class="btn-login">Alterar Senha</button>
<div id="mensagemSenha" class="mensagem"></div>
</form>
</div>
</div>
</div>
</div>
</div>

<script type="module">
const API_URL = 'http://localhost:3001';

// Estado da aplica√ß√£o
let userEmail = '';
let verificationCode = '';
let timerInterval = null;

// Elementos
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const emailForm = document.getElementById('emailForm');
const codeForm = document.getElementById('codeForm');
const passwordForm = document.getElementById('passwordForm');
const mensagemEmail = document.getElementById('mensagemEmail');
const mensagemCodigo = document.getElementById('mensagemCodigo');
const mensagemSenha = document.getElementById('mensagemSenha');
const emailDisplay = document.getElementById('emailDisplay');
const resendBtn = document.getElementById('resendBtn');
const timerSpan = document.getElementById('timer');
const backToEmail = document.getElementById('backToEmail');

// Fun√ß√£o para mostrar mensagens
function mostrarMensagem(elemento, texto, tipo) {
    elemento.textContent = texto;
    elemento.className = `mensagem ${tipo}`;
    elemento.style.display = 'block';
    
    setTimeout(() => {
        elemento.style.display = 'none';
    }, 5000);
}

// Fun√ß√£o para mudar de passo
function irParaPasso(passo) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    passo.classList.add('active');
}

// Timer para reenvio de c√≥digo
function iniciarTimer() {
    let segundos = 60;
    resendBtn.disabled = true;
    timerSpan.textContent = segundos;
    
    timerInterval = setInterval(() => {
        segundos--;
        timerSpan.textContent = segundos;
        
        if (segundos <= 0) {
            clearInterval(timerInterval);
            resendBtn.disabled = false;
            timerSpan.textContent = '0';
        }
    }, 1000);
}

// Passo 1: Enviar c√≥digo para o email
emailForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const btn = emailForm.querySelector('button');
    const originalText = btn.textContent;
    
    btn.textContent = 'Enviando...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`${API_URL}/auth/solicitar-recuperacao`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (data.success) {
            userEmail = email;
            emailDisplay.textContent = email;
            mostrarMensagem(mensagemEmail, 'C√≥digo enviado com sucesso!', 'sucesso');
            
            setTimeout(() => {
                irParaPasso(step2);
                iniciarTimer();
                document.querySelector('.code-digit').focus();
            }, 1500);
        } else {
            mostrarMensagem(mensagemEmail, data.error || 'Email n√£o encontrado', 'erro');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem(mensagemEmail, 'Erro ao conectar com o servidor', 'erro');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

// L√≥gica dos inputs de c√≥digo
const codeInputs = document.querySelectorAll('.code-digit');
codeInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
        const value = e.target.value;
        
        // Permitir apenas n√∫meros
        if (!/^\d$/.test(value)) {
            e.target.value = '';
            return;
        }
        
        // Mover para o pr√≥ximo input
        if (value && index < codeInputs.length - 1) {
            codeInputs[index + 1].focus();
        }
    });
    
    input.addEventListener('keydown', (e) => {
        // Voltar para o input anterior com Backspace
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
        }
    });
    
    // Colar c√≥digo completo
    input.addEventListener('paste', (e) => {
        e.preventDefault();
        const pasteData = e.clipboardData.getData('text').replace(/\D/g, '');
        
        if (pasteData.length === 6) {
            codeInputs.forEach((inp, i) => {
                inp.value = pasteData[i] || '';
            });
            codeInputs[5].focus();
        }
    });
});

// Passo 2: Verificar c√≥digo
codeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const code = Array.from(codeInputs).map(input => input.value).join('');
    
    if (code.length !== 6) {
        mostrarMensagem(mensagemCodigo, 'Digite o c√≥digo completo', 'erro');
        return;
    }
    
    const btn = codeForm.querySelector('button');
    const originalText = btn.textContent;
    
    btn.textContent = 'Verificando...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`${API_URL}/auth/verificar-codigo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: userEmail, code })
        });
        
        const data = await response.json();
        
        if (data.success) {
            verificationCode = code;
            mostrarMensagem(mensagemCodigo, 'C√≥digo verificado!', 'sucesso');
            
            setTimeout(() => {
                irParaPasso(step3);
                document.getElementById('novaSenha').focus();
            }, 1000);
        } else {
            mostrarMensagem(mensagemCodigo, data.error || 'C√≥digo inv√°lido', 'erro');
            codeInputs.forEach(input => input.value = '');
            codeInputs[0].focus();
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem(mensagemCodigo, 'Erro ao verificar c√≥digo', 'erro');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});

// Reenviar c√≥digo
resendBtn.addEventListener('click', async () => {
    const btn = emailForm.querySelector('button');
    btn.click();
    iniciarTimer();
});

// Voltar para o email
backToEmail.addEventListener('click', (e) => {
    e.preventDefault();
    irParaPasso(step1);
    clearInterval(timerInterval);
    codeInputs.forEach(input => input.value = '');
});

// Passo 3: Alterar senha
passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const novaSenha = document.getElementById('novaSenha').value;
    const confirmarSenha = document.getElementById('confirmarSenha').value;
    
    if (novaSenha !== confirmarSenha) {
        mostrarMensagem(mensagemSenha, 'As senhas n√£o coincidem', 'erro');
        return;
    }
    
    if (novaSenha.length < 6 || novaSenha.length > 20) {
        mostrarMensagem(mensagemSenha, 'A senha deve ter entre 6 e 20 caracteres', 'erro');
        return;
    }
    
    const btn = passwordForm.querySelector('button');
    const originalText = btn.textContent;
    
    btn.textContent = 'Alterando...';
    btn.disabled = true;
    
    try {
        const response = await fetch(`${API_URL}/auth/redefinir-senha`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: userEmail,
                code: verificationCode,
                nova_senha: novaSenha
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarMensagem(mensagemSenha, 'Senha alterada com sucesso! Redirecionando...', 'sucesso');
            
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        } else {
            mostrarMensagem(mensagemSenha, data.error || 'Erro ao alterar senha', 'erro');
        }
    } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem(mensagemSenha, 'Erro ao conectar com o servidor', 'erro');
    } finally {
        btn.textContent = originalText;
        btn.disabled = false;
    }
});
</script>
</body>
</html>